# customerTicketDemo
Задание мне очень понравилось, с удовольствием решил. Постарался выполнить все пункты.

Для запуска проекта нужно скачать mysql драйвер и создать базу данных customer_data_base, 
также нужно иметь свободным 8080 порт.

Java 8+,
Spring Boot,
Spring Data,
RestTemplate,
lombok, slf4j

===================

Сваггер доокументация:

![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/swagger.png)



Структура проекта:


![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/project.png)

====================

RequestRestController POST метод сохраняет заявки в базу данных. На вход принимает JSON, на выход отдает id заявки.



![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/request-post.png)

запрос для проверки
{
  "clientId": 3,
  "date": "2020-09-02 08:23:07",
  "executionStatus": "string",
  "requestId": 0,
  "requestStatus": 0,
  "routeNumber": 32
}

====================

RequestRestController GET метод выдает все заявки дата которых в будущем, для данного клиента, на вход принимает id клиента, отдает все заявки данного клиента у которых дата в будущем.


![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/request-get-future-data%7Bid%7D.png)

результат выполнения:
https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/get-future-data.json

=====================

RequestIDRestController отправляет заявки в StatusRestController, который генерирует случайную заявку. На вход принимает id заявки, указанный в URI, на выход отдает http статус.

В RequestIDRestController каждую минуту отправляет запрос CronJob, что бы провести еще раз попытку оплаты заявок со статусами 307 и 0.

До работы CronJob:


![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/get-request-check-%7Bid%7D%20before%20cron%20job.png)

=====================

Результат работы CronJob:

![alt text](https://github.com/ArtemSemeniuk7/customerTicketDemo/blob/master/get-request-check-%7Bid%7D%20after%20cron%20job.png)

======================


=== I ===
Разработать веб-приложение для оплаты билетов. Приложение должно состоять из HTTP API и логики проведения заявок.

API:
API работает в JSON формате и состоит из двух сервисов:
* Сервис приема заявок на оплату. Получает, валидирует и сохраняет заявку в БД.
На вход принимает номер маршрута и дату время отправления.
На выход отдает (в случае успеха) идентификатор заявки.

* Сервис проверки статуса заявки. Получает данные по заявке из БД.
На вход принимает идентификатор заявки.
На выход отдает статус заявки.

Логика проведения заявок
Процесс проведения оплаты (запускается раз в минуту):
+ * выбирает заявку, подходящую для проведения, из БД
+ * отправляет в http-сервис (сервис можно реализовать в этом же приложении отдельным endpoint-ом) платежного шлюза запрос, который случайным образом возвращает статусы (обрабатывается, ошибка, проведен)
+ * Обновляет статус заявки
Статусы "Ошибка" или "Проведен" являются конечными, т.е. повторение запроса не требуется

=== II ===
1. Доработать сервис приема заявок на оплату:
+ а) Необходимо добавить на вход сервиса обязательное поле - идентификатор клиента.
Реализовать сервис получения всех заявок по идентификатору клиента, дата отправления которых находится в будущем (> now). Полученные заявки необходимо отсортировать по дате отправления от ближайшей к дальнейшей. Сортировку необходимо реализовать на уровне API (не sql).
+ б) Необходимо учесть, что при приеме заявок возможны отправки дублей от внешнего комплекса. Например: два раза случайно отправили одну и ту же заявку на оплату в итоге платеж задублировался. Придумать и реализовать способ отсекать дубли в сервисе приема заявок на оплату.
Подсказка: можно добавить уникальность каждой заявки от внешнего комплекса, например - идентификатор билета.

2. Доработать процесс проведения заявок:
+ а) Необходимо учесть, что во время работы процесса в любой точке может произойти сбой или рестарт приложения. Придумать и реализовать способ подчищать поломанные заявки в случае такого сбоя и актуализировать статус этих заявок до конечного. В качестве проверки статуса платежа можно использовать текущий http-сервис платежного шлюза.
Подсказка: можно создать дополнительный статус - "начал обрабатывать" или "взял в обработку".

3. + Сделать процесс проведения заявок многопоточным. Необходимо создать возможность управления количеством потоков из конфигурации приложения.
